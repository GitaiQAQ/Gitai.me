<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="zh-Hans-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Android 打包流程 | Gitai.me</title>

<meta property='og:title' content='Android 打包流程 - Gitai.me'>
<meta property='og:description' content='这篇文章是解释Android程序如何被编译和执行的概述。
因为 Android 应用程序的执行过程包括像 DEX，APK，dx tool，aapt tool和javac等各种术语.所以我会先尝试各种工具并参与编译和构建一个 Android 应用程序。


.java: Java 文件拓展名
.class: Java 文件编译后，一种8位字节的二进制流文件， 各个数据项按顺序紧密的从前向后排列， 相邻的项之间没有间隙， 这样可以使得class文件非常紧凑， 体积轻巧， 可以被JVM快速的加载至内存， 并且占据较少的内存空间。
DEX: Dalvik EXecutable file. 所有的.class文件内容整合到一个.dex文件
JVM: Java Virtual Machine. 基于虚拟栈的虚拟机
DVM: Dalvik Virtual Machine. 基于寄存器的虚拟机
AIDL: Android Interface Definition Language
apk: Android Application Package file.
aidl: converts all AIDL files into .java files.
dx: convert all .class files into a single DEX file.
apkbuilder
zipalign
'>
<meta property='og:url' content='https://gitai.me/2016/06/android-application-build-or-compilation-process/'>
<meta property='og:site_name' content='Gitai.me'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/d277f292abb792ca53d809be58cb3d85?s=256'><meta property='article:section' content='Posts'><meta property='article:tag' content='记录'><meta property='article:tag' content='原理分析'><meta property='article:published_time' content='2016-06-20T07:04:34Z'/><meta property='article:modified_time' content='2016-06-20T07:04:34Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@_gitai'><meta name='twitter:creator' content='@_gitai'>


<link rel="stylesheet" href="/css/style.css"/>




<link rel="canonical" href="https://gitai.me/2016/06/android-application-build-or-compilation-process/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://gitai.me/">
          
            <img class="logo" src="/img/logo.gif" alt="Gitai.me"/>
          
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/GitaiQAQ'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/_gitai'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:i@gitai.me'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <div class="dividing-line"></div>
    <div class="content">
      <blockquote>
        <p>
          系统更换中，可能存在不可预料的 BUG
        </p>
      </blockquote>
    </div>

    

  </div>
  
</section>
<article>
  <section class="left-menu ">
</section>
  <section class="section">
    <div class="container">
      <div class="subtitle tags is-6 is-pulled-right">
        
        
<a class="subtitle is-6" href="/tags/%E8%AE%B0%E5%BD%95/">#记录</a>



  
  | <a class="subtitle is-6" href="/tags/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90/">#原理分析</a>
  


        
      </div>
      <h2 class="subtitle is-6">June 20, 2016</h2>
      <h1 class="title">Android 打包流程</h1>
      
      <div class="content">
        <p>这篇文章是解释Android程序如何被编译和执行的概述。</p>
<p>因为 Android 应用程序的执行过程包括像 DEX，APK，dx tool，aapt tool和javac等各种术语.所以我会先尝试各种工具并参与编译和构建一个 Android 应用程序。</p>
<p><img src="/img/android-application-build-process-diagram.png" alt="android-application-build-process-diagram"></p>
<ul>
<li><code>.java</code>: Java 文件拓展名</li>
<li><code>.class</code>: Java 文件编译后，一种8位字节的二进制流文件， 各个数据项按顺序紧密的从前向后排列， 相邻的项之间没有间隙， 这样可以使得class文件非常紧凑， 体积轻巧， 可以被JVM快速的加载至内存， 并且占据较少的内存空间。</li>
<li><code>DEX</code>: Dalvik EXecutable file. 所有的.class文件内容整合到一个.dex文件</li>
<li><code>JVM</code>: Java Virtual Machine. 基于虚拟栈的虚拟机</li>
<li><code>DVM</code>: Dalvik Virtual Machine. 基于寄存器的虚拟机</li>
<li><code>AIDL</code>: Android Interface Definition Language</li>
<li><code>apk</code>: Android Application Package file.</li>
<li><code>aidl</code>: converts all AIDL files into .java files.</li>
<li><code>dx</code>: convert all .class files into a single DEX file.</li>
<li><code>apkbuilder</code></li>
<li><code>zipalign</code></li>
</ul>
<p>JVM 与 DVM 区别</p>
<ol>
<li>dvm执行的是.dex格式文件  jvm执行的是.class文件   Android程序编译完之后生产.class文件，然后，dex工具会把.class文件处理成.dex文件，然后把资源文件和.dex文件等打包成.apk文件。apk就是android package的意思。 jvm执行的是.class文件。</li>
<li>dvm是基于寄存器的虚拟机  而jvm执行是基于虚拟栈的虚拟机。寄存器存取速度比栈快的多，dvm可以根据硬件实现最大的优化，比较适合移动设备。</li>
<li>.class文件存在很多的冗余信息，dex工具会去除冗余信息，并把所有的.class文件整合到.dex文件中。减少了I/O操作，提高了类的查找速度</li>
</ol>
<p>DVM有如下特征：</p>
<ol>
<li>使用专有的.dex格式。</li>
<li>java类文件在编译过后，会产生至少一个.class文件包含大量陈余信息，dex文件格式会把所有的.class文件内容整合到一个.dex文件中。即减少了整体文件的尺寸和IO操作，也提高了类的查找速度。</li>
<li>增加了对新的操作码的支持</li>
<li>文件结构尽量简洁，使用等长的指令，借以提高解析速度。</li>
<li>尽量扩大只读结构的大小，借以提高跨进程的数据共享。</li>
<li>dex的优化，dex文件的结构是紧凑的，但是如果想提高运行时的性能，就需要对dex文件进行进一步的优化，这些优化针对以下几个方面：
<ol>
<li>验证dex文件中的所有类</li>
<li>对一些特定的类和方法里面的操作码进行优化</li>
<li>调整所有的字节序(Little_endian)和对齐结构中的每一个域</li>
<li>基于寄存器，基于寄存器的虚拟机虽然比基于堆栈的虚拟机在硬件，通用性上要差一些，但是它的代码执行效率去更好</li>
<li>每一个Android应用都运行在它自己的DVM实例中，每一个DVM实例都是一个独立的进程空间。所有的Android应用的线程都对应一个Linux线程，DVM因此可以更多地依赖操作系统的线程调度和管理机制。不同的应用在不同的进程空间里运行，不同的应用都是用不同的Linux用户来运行以最大程度地保户应用程序的安全性和独立性</li>
</ol>
</li>
</ol>
<h2 id="手动编译">手动编译</h2>
<pre><code>$ tree
.
├── AndroidManifest.xml
├── java
│   └── me
│       └── gitai
│           └── hosts
│               ├── Constant.java
│               └── HostsApp.java
└── res
    ├── drawable-hdpi
    │   ├── ic_add_white.png
    │   └── ic_search_white.png
    ├── drawable-mdpi
    │   ├── ic_add_white.png
    │   └── ic_search_white.png
    ├── layout
    │   ├── activity_main.xml
    ├── menu
    │   └── main.xml
    ├── mipmap-hdpi
    │   └── ic_launcher.png
    ├── mipmap-mdpi
    │   └── ic_launcher.png
    ├── mipmap-xhdpi
    │   └── ic_launcher.png
    ├── mipmap-xxhdpi
    │   └── ic_launcher.png
    ├── values
    │   ├── colors.xml
    │   ├── dimens.xml
    │   ├── strings.xml
    │   └── styles.xml
    └── values-large
         └── dimens.xml

</code></pre><h3 id="生成rjava">生成R.java</h3>
<pre><code>$ mkdir -p ./gen/&lt;packageName&gt;
$ aapt package -f -m -J ./gen -S res -M AndroidManifest.xml -I '/Sdk/platforms/android-24/android.jar'
</code></pre><ul>
<li><code>-f</code>: 如果编译生成的文件已经存在，强制覆盖。</li>
<li><code>-m</code>: 使生成的包的目录存放在-J参数指定的目录</li>
<li><code>-J</code>: 指定生成的R.java 的输出目录路径</li>
<li><code>-S</code>: 指定res文件夹的路径precedence.</li>
<li><code>-A</code>: 指定assert文件夹的路径</li>
<li><code>-M</code>: AndroidManifest.xml 路径</li>
<li><code>-I</code>: 指定某个版本平台的 android.jar 文件的路径</li>
</ul>
<h3 id="把aidl转成java文件">把.aidl转成.java文件</h3>
<pre><code>$ aidl
INPUT required
usage: aidl OPTIONS INPUT [OUTPUT]
       aidl --preprocess OUTPUT INPUT...

OPTIONS:
   -I &lt;DIR&gt;    search path for import statements.
   -d &lt;FILE&gt;   generate dependency file.
   -a         generate dependency file next to the output file with the name based on the input file.
   -p &lt;FILE&gt;   file created by --preprocess to import.
   -o &lt;FOLDER&gt; base output folder for generated files.
   -b         fail when trying to compile a parcelable.

INPUT:
   An aidl interface file.

OUTPUT:
   The generated interface files.
   If omitted and the -o option is not used, the input filename is used, with the .aidl extension changed to a .java extension.
   If the -o option is used, the generated files will be placed in the base output folder, under their package folder
</code></pre><h3 id="编译java类文件">编译.java类文件</h3>
<pre><code>$ mkdir bin
$ javac -encoding UTF-8 -target 1.8 -bootclasspath '/Sdk/platforms/android-24/android.jar' -d ./bin src/&lt;packageName&gt;/*.java ./gen/&lt;packageName&gt;/R.java 
</code></pre><ul>
<li><code>-target &lt;版本&gt;</code>                             生成特定 VM 版本的类文件</li>
<li><code>-bootclasspath &lt;路径&gt;</code>          覆盖引导类文件的位置</li>
<li><code>-d &lt;目录&gt;</code>                                          指定存放生成的类文件的位置</li>
<li><code>-sourcepath &lt;路径&gt;</code>                  指定查找输入源文件的位置</li>
</ul>
<h3 id="class文件生成dex文件">class文件生成dex文件</h3>
<pre><code>$ dx --dex --output=./bin/classes.dex  ./bin/classes
</code></pre><h3 id="打包资源">打包资源</h3>
<pre><code>$ aapt package -f -M AndroidManifest.xml -S res -A assets -I '/Sdk/platforms/android-24/android.jar' -F ./bin/&lt;packageName&gt;
</code></pre><ul>
<li><code>-f</code> 如果编译生成的文件已经存在，强制覆盖</li>
<li><code>-M</code> 指定 AndroidManifest.xml 的路径</li>
<li><code>-S</code> 指定 res 文件夹路径</li>
<li><code>-I</code> 指定某个版本平台的 android.jar 的路径</li>
<li><code>-F</code> 指定输出文件完整路径</li>
</ul>
<h3 id="生成未签名的apk">生成未签名的apk</h3>
<pre><code>$ apkbuilder  ./bin/&lt;packageName&gt;.apk -u -z  ./bin/&lt;packageName&gt; -f  ./bin/classes.dex  -rf  ./src  -rj  ./libs 
</code></pre><p>在SDK 22之后 apkbuilder 被新构建工具取代</p>
<pre><code>$ java -classpath sdklib.jar com.android.sdklib.build.ApkBuilderMain 
</code></pre><ul>
<li><code>-v</code>   Verbose 显示过程信息</li>
<li><code>-u</code>   创建一个无签名的包</li>
<li><code>-z</code>   指定apk资源路径</li>
<li><code>-f</code>   指定dex文件路径</li>
<li><code>-rf</code> 指定源码路径</li>
<li><code>-rj</code> libs路径</li>
</ul>
<h3 id="创建密匙">创建密匙</h3>
<pre><code>$ keytool -genkey -alias release -keyalg RSA -validity 20000 -keystore &lt;keyStore&gt;  
</code></pre><ul>
<li><code>-genkey</code>         在用户主目录中创建一个默认文件&quot;.keystore&quot;</li>
<li><code>-alias</code>            产生别名</li>
<li><code>-keyalg</code>         指定密钥的算法</li>
<li><code>-validity</code>    指定创建的证书有效期多少天</li>
<li><code>-keystore</code>    指定密钥库的名称(产生的各类信息将不在.keystore文件中)</li>
</ul>
<h3 id="签名apk">签名apk</h3>
<pre><code>$ jarsigner  -verbose -keystore &lt;keyStore&gt; -storepass &lt;storePass&gt; -keypass &lt;keyPass&gt; -signedjar &lt;signedApk&gt; &lt;unsignedApk&gt;release
</code></pre><ul>
<li><code>-verbose</code>          签名/验证时输出详细信息</li>
<li><code>-keystore</code>        密钥库位置</li>
<li><code>-storepass</code>     用于密钥库完整性的口令</li>
<li><code>-keyPass</code>          专用密钥的口令（如果不同）</li>
<li><code>-signedjar</code>    已签名的 JAR 文件的名称</li>
</ul>
<h3 id="对齐">对齐</h3>
<pre><code>$ zipalign -v 4 &lt;sourceApk&gt; &lt;outputApk&gt;
</code></pre><p>验证对齐</p>
<pre><code>$ zipalign -c -v 4 &lt;application&gt;
</code></pre><h2 id="refs">Refs</h2>
<ol>
<li>
<p><a href="http://www.c-sharpcorner.com/UploadFile/34ef56/android-application-build-process-or-compilation-process/">Android Application Build Process or Compilation Process</a></p>
</li>
<li>
<p><a href="http://blog.csdn.net/fangchao3652/article/details/42246049">class 文件与dex文件区别 （dvm与jvm区别）及Android DVM介绍 - 博客频道</a></p>
</li>
<li>
<p><a href="https://stackoverflow.com/questions/16620655/i-have-updated-android-sdk-to-rev-22-yesterday-and-there-is-no-apkbuilder-in-to">I have updated Android SDK to rev. 22 yesterday and there is no apkbuilder in tools</a></p>
</li>
</ol>
        
        <div class="related">
</div>
        
      </div>
      
    </div>
    
<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'gitaisblog';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


  </section>
  <section class="right-menu ">
    <div class="TableOfContents">
        
            <label><svg style="height: 1.5em; vertical-align: middle;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg"><path d="M576 256 96 256C76.8 256 64 243.2 64 224s12.8-32 32-32l480 0c19.2 0 32 12.8 32 32S595.2 256 576 256z" p-id="2531" fill="#2c2c2c"></path><path d="M576 544 96 544c-19.2 0-32-12.8-32-32s12.8-32 32-32l480 0c19.2 0 32 12.8 32 32S595.2 544 576 544z" p-id="2532" fill="#2c2c2c"></path><path d="M928 832 96 832c-19.2 0-32-12.8-32-32s12.8-32 32-32l832 0c19.2 0 32 12.8 32 32S947.2 832 928 832z" p-id="2533" fill="#2c2c2c"></path><path d="M768 544c-9.6 0-16-3.2-22.4-9.6-12.8-12.8-9.6-32 3.2-44.8l134.4-121.6-134.4-121.6c-12.8-12.8-12.8-32-3.2-44.8 12.8-12.8 32-12.8 44.8-3.2l160 144c6.4 6.4 9.6 16 9.6 22.4s-3.2 19.2-9.6 22.4l-160 144C784 540.8 774.4 544 768 544z" p-id="2534" fill="#2c2c2c"></path></svg>&nbsp;&nbsp;What's on this page</label>
            <div class="TableOfContents">
                <nav id="TableOfContents">
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#手动编译">手动编译</a>
      <ul>
        <li><a href="#生成rjava">生成R.java</a></li>
        <li><a href="#把aidl转成java文件">把.aidl转成.java文件</a></li>
        <li><a href="#编译java类文件">编译.java类文件</a></li>
        <li><a href="#class文件生成dex文件">class文件生成dex文件</a></li>
        <li><a href="#打包资源">打包资源</a></li>
        <li><a href="#生成未签名的apk">生成未签名的apk</a></li>
        <li><a href="#创建密匙">创建密匙</a></li>
        <li><a href="#签名apk">签名apk</a></li>
        <li><a href="#对齐">对齐</a></li>
      </ul>
    </li>
    <li><a href="#refs">Refs</a></li>
  </ul>
</nav>
                </nav>
            </div>
        
    </div>
    
</section>
</article>

    <script src="/js/copycode.js"></script>

<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/GitaiQAQ">Gitai</a> 2011</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>



</body>
</html>

