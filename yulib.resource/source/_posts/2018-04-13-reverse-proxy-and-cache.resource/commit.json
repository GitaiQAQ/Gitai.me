{"compress":true,"commitItems":[["ce8a86a1-1cf8-4261-bf63-249c26e86798",1524046207362,"---\n\n  layout:     post\n  title:      \"无脑的反代+缓存说明书\"\n  date:       2018-04-13\n  author:     \"Gitai\"\n  categories:\n      - 小脚本\n---\n\n\n除了微博这个好图床，BAT 三家都有对应的防盗链机制。\n\n![](http://mmbiz.qpic.cn/mmbiz_png/XYVZfgnKcyjElWSLP2wIzbsIBibgWzzNThmHUFkuEiapBD4hmHm8k1QvdOqUo2ZCDZ9A0ZWicDHugCVrJRNHOs8jw/640)\n![](http://112.74.108.69:8000/mmbiz_png/XYVZfgnKcyjElWSLP2wIzbsIBibgWzzNThmHUFkuEiapBD4hmHm8k1QvdOqUo2ZCDZ9A0ZWicDHugCVrJRNHOs8jw/640)\n\n一般来说，上左图就会被 ban，而右侧就是反代成功的。\n\n我们能通过反代，很轻巧的解决这个问题，即使不说反盗链，反代还有其他用途。\n\n<!-- more -->\n\n## Caddy\n\n```\n:80 {\n        proxy /mmbiz_jpg http://mmbiz.qpic.cn\n}\n```\n\n简单粗暴，最基本的反代就完成了。\n\n但是 `mmbiz.qpic.cn` 的报错非常不友好，一般都是自己写个后端接上调试，或者用抓包工具拦截，但是有几个非常好用的服务这时候就值得推荐了。\n\n如同 `example.com` 一样的更为适合作为例子使用的一类服务，在此以 `httpbin.org` 为例子。其中有个 `anything` 的接口，会把访问携带的参数全部打印出来。\n\n```\n:80 {\n        proxy /mmbiz_jpg http://httpbin.org/anything\n}\n```\n然后继续以页首的为例，会获得如下 JSON 数据。\n\n```\n{\n  \"args\": {\n    \"wx_fmt\": \"jpeg\"\n  }, \n  \"data\": \"\", \n  \"files\": {}, \n  \"form\": {}, \n  \"headers\": {\n    \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\", \n    \"Accept-Encoding\": \"gzip, deflate\", \n    \"Accept-Language\": \"zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7\", \n    \"Connection\": \"close\", \n    \"Cookie\": \"wp-settings-time-1=1519806291; wordpress_logged_in_ac0818ef3df8d5d8ee0c025b0c25a7af=0.%E6%B5%8B%E8%AF%95%E7%94%A8%E6%88%B7%7C1520337495%7CB1MSh82sorzJldJf5uyTMNsVyTEwl4ceeAfes3ZqMZT%7Cc3864d5561528961921f2e797322877d945e0c4c0eeeb7633ea7c8d8defc91b9\", \n    \"Host\": \"httpbin.org\", \n    \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36\"\n  }, \n  \"json\": null, \n  \"method\": \"GET\", \n  \"origin\": \"171.110.30.*, 112.74.108.*\", \n  \"url\": \"http://httpbin.org/anything/mmbiz_jpg/AyxiaR9c8c68jZyJgca9R2kno7THAeXaEoeM4RtLutq6UYFfn5E0gRANz6tVKTXibNMj0GLw969W5Boub5rTJhYg/0?wx_fmt=jpeg\"\n}\n```\n通过上面的数据，会发现携带了不少没什么用的参数，这些参数还可能暴露这是反代这回事。\n\n于是用 `header_upstream` 参数和 `-` 操作符，去除无用的头部元素。\n\n```\nproxy /mmbiz_jpg http://httpbin.org/anything {\n        header_upstream -Cookie\n}\n```\n然后可以得到如下内容\n\n```\n{\n  \"args\": {\n    \"wx_fmt\": \"jpeg\"\n  }, \n  \"data\": \"\", \n  \"files\": {}, \n  \"form\": {}, \n  \"headers\": {\n    \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\", \n    \"Accept-Encoding\": \"gzip, deflate\", \n    \"Accept-Language\": \"zh-CN,zh;q=0.9,en;q=0.8,ja;q=0.7\", \n    \"Connection\": \"close\", \n    \"Host\": \"httpbin.org\", \n    \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36\"\n  }, \n  \"json\": null, \n  \"method\": \"GET\", \n  \"origin\": \"171.110.30.*, 112.74.108.*\", \n  \"url\": \"http://httpbin.org/anything/mmbiz_jpg/AyxiaR9c8c68jZyJgca9R2kno7THAeXaEoeM4RtLutq6UYFfn5E0gRANz6tVKTXibNMj0GLw969W5Boub5rTJhYg/0?wx_fmt=jpeg\"\n}\n```\n`Cookie` 已经被移除了。\n\n接下来为它加上缓存，毕竟每次都从上游服务器抓取，总会被 ban 的。\n\n```\ncache {\n        match_path /\n        status_header X-Cache-Status\n        default_max_age 60m\n        path /tmp/caddy-cache\n}\n```\n在此并没有使用 `match_header` 对数据类型进行限制，所以会缓存全部数据。下面这段即可过滤 `image` 类型的数据。\n\n```\nmatch_header Content-Type image/*\n```\n\n在对应的响应头中能发现 `X-Cache-Status: hit` 这一字段，也会在 `/tmp/caddy-cache` 中发现对应的缓存文件。\n\n脱离反代程序本身如果想要测试缓存，可以用 `http://lorempixel.com`，该站有很多常见的占位图片。\n\n然后把 `http://httpbin.org/anything` 换成目标地址 `http://mmbiz.qpic.cn`，并在前端 hack 惰性加载，替换域名完成反代。\n\n完整配置文件如下：\n\n```\n:80 {\n        proxy /mmbiz_jpg http://mmbiz.qpic.cn {\n                header_upstream -Cookie\n\t\t\t\theader_upstream referer \"http://mp.weixin.qq.com\"\n        }\n        cache {\n                match_path /\n                status_header X-Cache-Status\n                default_max_age 60m\n                path /tmp/caddy-cache\n        }\n}\n```\n这里还用 `header_upstream` 伪造了来自微信公众号平台的头。\n\n## 传统后端网关\n\n因为一般都已经运行了 Apache 或者 Nginx，所以再把上述 Caddyfile \"翻译\" 成对应的配置脚本。\n\n### Nginx\n\n```\nproxy_cache_path /tmp/nginx_cache levels=1:2 keys_zone=my_cache:60m max_size=10g inactive=60m u\nse_temp_path=on;\nserver {\n    listen       80;\n    listen       [::]:80;\n\n    location / {\n        proxy_pass http://mmbiz.qpic.cn;\n        proxy_set_header referer \"http://mp.weixin.qq.com\";\n\n        proxy_set_header   Cookie \"\";\n        proxy_set_header User-Agent $http_user_agent;\n        proxy_cache my_cache;\n    }\n}\n```\n```\ndocker run -p 80:80 -v $PWD/nginx.conf:/etc/nginx/conf.d/default.conf:ro -it --rm nginx\n```\n### Apache[^creating-a-caching-proxy-server-with-apache]\n\n```\n<VirtualHost *:80>\n\tServerName _\n\n\t# Cache\n\t# Not work\n\tLoadModule cache_module modules/mod_cache.so\n\n\t<IfModule mod_cache.c>\n\t\tLoadModule cache_disk_module modules/mod_cache_disk.so\n\t\t<IfModule mod_disk_cache.c>\n\t\t\tCacheEnable disk /\n\t\t\tCacheRoot /var/www/example.com/cache/\n\t\t\tCacheIgnoreNoLastMod  On\n\t\t\tCacheDefaultExpire 86400\n\t\t\tHeader unset Expires\n\t\t\tHeader unset Cache-Control\n\t\t\tHeader unset Pragma \n\t\t</IfModule> \n\t</IfModule>\n\n\n\tLoadModule proxy_module modules/mod_proxy.so\n\tLoadModule proxy_connect_module modules/mod_proxy_connect.so\n\tLoadModule proxy_http_module modules/mod_proxy_http.so\n\n\t#Proxy \n\tProxyRequests  On \n\tProxyPass / http://mmbiz.qpic.cn/\n\tProxyPassReverse / http://mmbiz.qpic.cn/\n\n\tRequestHeader set referer \"http://mp.weixin.qq.com\"\n\tRequestHeader unset Cookie\n\tRequestHeader unset \"X-Forwarded-Host\"\n\tRequestHeader unset \"X-Forwarded-Server\"\n</VirtualHost>\n```\n通过 docker 启动，要不容易污染环境。\n\n```\ndocker run -p 80:80 -v $PWD/httpd.conf:/usr/local/apache2/conf/httpd.conf -it --rm httpd\n```\n除了缓存好像没生效，其他没什么问题。\n\n\n[^creating-a-caching-proxy-server-with-apache]: [Creating a caching proxy server with apache](https://aoeex.com/phile/creating-a-caching-proxy-server-with-apache/)\n\n",[[1524046199596,["10760@DESKTOP-DPDMN5A",[[1,160,"\n"]],[159,159],[160,160]]]]]]}