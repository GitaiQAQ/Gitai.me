<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"  lang="zh-Hans-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>私有 Docker Registry 配置的一个小坑 | Gitai.me</title>

<meta property='og:title' content='私有 Docker Registry 配置的一个小坑 - Gitai.me'>
<meta property='og:description' content='$ sudo docker sudo docker login -u username -p password example.com:5000 Error response from daemon: Get https://example:5000/v2/: x509: certificate signed by unknown authority 对此问题 Google 和 Github 已经有了很多资料，只是证书问题或者配置问题，然后遇上两端都是被高度封装的系统，相'>
<meta property='og:url' content='https://gitai.me/2018/09/docker-registry/'>
<meta property='og:site_name' content='Gitai.me'>
<meta property='og:type' content='article'><meta property='og:image' content='https://www.gravatar.com/avatar/d277f292abb792ca53d809be58cb3d85?s=256'><meta property='article:section' content='Posts'><meta property='article:tag' content='Docker'><meta property='article:published_time' content='2018-09-21T00:00:00Z'/><meta property='article:modified_time' content='2018-09-21T00:00:00Z'/><meta name='twitter:card' content='summary'><meta name='twitter:site' content='@_gitai'><meta name='twitter:creator' content='@_gitai'>


<link rel="stylesheet" href="/css/style.css"/><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<link rel="canonical" href="https://gitai.me/2018/09/docker-registry/">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
<section class="section">
  <div class="container">
    <nav id="nav-main" class="nav">
      <div id="nav-name" class="nav-left">
        <a id="nav-anchor" class="nav-item" href="https://gitai.me/">
          
            <img class="logo" src="/img/logo.gif" alt="Gitai.me"/>
          
        </a>
      </div>
      <div class="nav-right">
        <nav id="nav-items" class="nav-item level is-mobile"><a class="level-item" aria-label="github" href='https://github.com/GitaiQAQ'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/_gitai'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:i@gitai.me'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a></nav>
      </div>
    </nav>

    <div class="dividing-line"></div>
    <div class="content">
      <blockquote>
        <p>
          系统更换中，可能存在不可预料的 BUG
        </p>
      </blockquote>
    </div>

    

  </div>
  <script src="/js/navicon-shift.js"></script>
</section>
<section class="section">
  <div class="container">
    <div class="subtitle tags is-6 is-pulled-right">
      
      
<a class="subtitle is-6" href="/tags/docker/">#Docker</a>




      
    </div>
    <h2 class="subtitle is-6">September 21, 2018</h2>
    <h1 class="title">私有 Docker Registry 配置的一个小坑</h1>
    
    <div class="content">
      <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo docker sudo docker login -u username -p password example.com:5000
Error response from daemon: Get https://example:5000/v2/: x509: certificate signed by unknown authority

</code></pre></div><p>对此问题 Google 和 Github 已经有了很多资料，只是证书问题或者配置问题，然后遇上两端都是被高度封装的系统，相比直接遇上稍微复杂一点点。所以在此只是记下分析的过程。</p>
<!-- raw HTML omitted -->
<h2 id="使用-lets-encrypt-签发的证书">使用 <code>Let's Encrypt</code> 签发的证书</h2>
<p>通过 <code>acme.sh</code> 会生成如下文件目录，对于我这种完全不知道 TSL/SSL 协议啥子原理的，就开始蒙了。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ tree
.
├── ca.cer
├── fullchain.cer
├── example.com.cer
├── example.com.conf
├── example.com.csr
├── example.com.csr.conf
└── example.com.key

<span style="color:#ae81ff">0</span> directories, <span style="color:#ae81ff">7</span> files

</code></pre></div><p>于是会在参照 <a href="https://docs.docker.com/engine/security/certificates/#creating-the-client-certificates">Docker Doc</a> 配置的时候，遇上上述问题。</p>
<pre><code>REGISTRY_HTTP_TLS_CERTIFICATE: /certs/domain.crt
REGISTRY_HTTP_TLS_KEY: /certs/domain.key
</code></pre><p>该配置是在 <a href="https://github.com/docker/distribution/blob/059f301d548d58085032e6af149a08352221f792/registry/registry.go#L135">registry.go#L135</a> 中被使用的。</p>
<p>DER、CER、CRT以二进制形式存放证书，只有公钥，不包含私钥。<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
<p>所以直接导入。</p>
<p>于是遇上导入哪个的问题，先来看看之前申请的证书文件。</p>
<ul>
<li>CSR 证书请求</li>
<li>CER 证书文件</li>
</ul>
<p>然后通过以下命令。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ cat example.cer.cer ca.cer &gt; test.cer
$ diff test.cer fullchain.cer

</code></pre></div><p>那这个 <code>fullchain</code> 有啥用？</p>
<p>自然我们已经绑定了 IP，并启动 <code>registry</code> 了，可以先通过一个 <a href="https://myssl.com/ssl.html">SSL 服务</a>检测证书状态。</p>
<p>并按照上述建议修改问题，提供安全性。</p>
<p>如果之前用的是 example.cer 就会遇到这提示。</p>
<p><img src="https://i.loli.net/2018/09/21/5ba483d416a94.png" alt="RSA 证书, 证书链不完整"></p>
<p>虽然不明白为什么没有详情可以看。</p>
<p>于是替换成 fullchain 就能解决这个问题。</p>
<p>最后就会变成这样：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">/etc/docker/certs.d tree
.
└── example.com:5000
    ├── ca.crt     --&gt; ca.cer
    ├── client.crt --&gt; fullchain.cer
    └── client.key --&gt; example.com.key

<span style="color:#ae81ff">1</span> directory, <span style="color:#ae81ff">2</span> files
</code></pre></div><h2 id="自签名证书">自签名证书</h2>
<blockquote>
<p>相比 <code>Let's Encrypt</code> 签发的证书，自签发的只有需要来回复制证书这个缺点。</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo openssl req -newkey rsa:4096 -nodes -sha256 -keyout client.key -x509 -days <span style="color:#ae81ff">365</span> -out ca.crt

</code></pre></div><p>导入 registry 内，即可使用。</p>
<h2 id="脱离-docker-的测试">脱离 Docker 的测试</h2>
<p>但是通过最开始的错误报告，能发现有这么个接口</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl --cacert ca.crt -u username:password https://example.com:5000/v2/

</code></pre></div><p>当接口能直接访问的时候，就说明调试成功了</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://blog.freessl.org/ssl-cert-format-introduce/">SSL 证书格式普及，PEM、CER、JKS、PKCS12</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

      
      <div class="related">
</div>
      
    </div>
    
  </div>
</section>

    <script src="/js/copycode.js"></script>


<section class="section">
  <div class="container">
    <aside><div id="disqus_thread"></div></aside>
  
    <script type="text/javascript">
      var disqus_shortname = 'gitaisblog';
      function disqus() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }
  
      disqus();
  

    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
  </div>
</section>


<section class="section">
  <div class="container has-text-centered">
    <p>&copy; <a href="https://github.com/GitaiQAQ">Gitai</a> 2011</p>
    
      <p>Powered by <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/ribice/kiss">Kiss</a>.</p>
    
  </div>
</section>



</body>
</html>

